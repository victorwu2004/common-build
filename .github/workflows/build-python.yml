name: Build Python Application

on:
  workflow_call:
    inputs:
      python-version:
        description: 'Python version'
        required: false
        type: string
        default: '3.11'
      package-manager:
        description: 'Package manager (pip, poetry, pipenv)'
        required: false
        type: string
        default: 'pip'
      working-directory:
        description: 'Working directory'
        required: false
        type: string
        default: '.'
      artifact-name:
        description: 'Name for the build artifact'
        required: true
        type: string
      run-tests:
        description: 'Run unit tests'
        required: false
        type: boolean
        default: true
      test-command:
        description: 'Custom test command'
        required: false
        type: string
        default: ''
      build-wheel:
        description: 'Build wheel distribution'
        required: false
        type: boolean
        default: true
      requirements-file:
        description: 'Path to requirements file'
        required: false
        type: string
        default: 'requirements.txt'
    outputs:
      artifact-path:
        description: 'Path to the built artifact'
        value: ${{ jobs.build.outputs.artifact-path }}
      version:
        description: 'Build version'
        value: ${{ jobs.build.outputs.version }}

jobs:
  build:
    runs-on: ubuntu-latest
    outputs:
      artifact-path: ${{ steps.package.outputs.artifact-path }}
      version: ${{ steps.version.outputs.version }}
    
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python-version }}

      - name: Install Poetry
        if: inputs.package-manager == 'poetry'
        uses: snok/install-poetry@v1
        with:
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache dependencies (pip)
        if: inputs.package-manager == 'pip'
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements*.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache dependencies (poetry)
        if: inputs.package-manager == 'poetry'
        uses: actions/cache@v4
        with:
          path: .venv
          key: ${{ runner.os }}-poetry-${{ hashFiles('**/poetry.lock') }}
          restore-keys: |
            ${{ runner.os }}-poetry-

      - name: Generate version
        id: version
        run: |
          if [[ -f "pyproject.toml" ]]; then
            BASE_VERSION=$(grep -m1 'version' pyproject.toml | cut -d'"' -f2 || echo "1.0.0")
          elif [[ -f "setup.py" ]]; then
            BASE_VERSION=$(python setup.py --version 2>/dev/null || echo "1.0.0")
          else
            BASE_VERSION="1.0.0"
          fi
          
          if [[ "${{ github.ref }}" == "refs/heads/main" || "${{ github.ref }}" == "refs/heads/master" ]]; then
            VERSION="${BASE_VERSION}"
          else
            VERSION="${BASE_VERSION}.dev${{ github.run_number }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Install dependencies (pip)
        if: inputs.package-manager == 'pip'
        run: |
          python -m pip install --upgrade pip setuptools wheel
          if [[ -f "${{ inputs.requirements-file }}" ]]; then
            pip install -r ${{ inputs.requirements-file }}
          fi
          if [[ -f "requirements-dev.txt" ]]; then
            pip install -r requirements-dev.txt
          fi
          pip install build pytest pytest-cov flake8

      - name: Install dependencies (poetry)
        if: inputs.package-manager == 'poetry'
        run: |
          poetry install --with dev

      - name: Install dependencies (pipenv)
        if: inputs.package-manager == 'pipenv'
        run: |
          pip install pipenv
          pipenv install --dev

      - name: Run linting
        run: |
          if [[ "${{ inputs.package-manager }}" == "poetry" ]]; then
            poetry run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          elif [[ "${{ inputs.package-manager }}" == "pipenv" ]]; then
            pipenv run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          else
            flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || true
          fi
        continue-on-error: true

      - name: Run tests (pip)
        if: inputs.run-tests && inputs.package-manager == 'pip'
        run: |
          if [[ -n "${{ inputs.test-command }}" ]]; then
            ${{ inputs.test-command }}
          else
            pytest --cov --cov-report=xml --cov-report=html --junitxml=junit.xml || true
          fi

      - name: Run tests (poetry)
        if: inputs.run-tests && inputs.package-manager == 'poetry'
        run: |
          if [[ -n "${{ inputs.test-command }}" ]]; then
            poetry run ${{ inputs.test-command }}
          else
            poetry run pytest --cov --cov-report=xml --cov-report=html --junitxml=junit.xml || true
          fi

      - name: Run tests (pipenv)
        if: inputs.run-tests && inputs.package-manager == 'pipenv'
        run: |
          if [[ -n "${{ inputs.test-command }}" ]]; then
            pipenv run ${{ inputs.test-command }}
          else
            pipenv run pytest --cov --cov-report=xml --cov-report=html --junitxml=junit.xml || true
          fi

      - name: Upload test results
        if: inputs.run-tests && always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-python
          path: |
            ${{ inputs.working-directory }}/coverage.xml
            ${{ inputs.working-directory }}/htmlcov
            ${{ inputs.working-directory }}/junit.xml
          retention-days: 7
        continue-on-error: true

      - name: Build wheel (pip)
        if: inputs.build-wheel && inputs.package-manager == 'pip'
        run: |
          python -m build

      - name: Build wheel (poetry)
        if: inputs.build-wheel && inputs.package-manager == 'poetry'
        run: |
          poetry build

      - name: Build wheel (pipenv)
        if: inputs.build-wheel && inputs.package-manager == 'pipenv'
        run: |
          pipenv run python -m build

      - name: Package artifacts
        id: package
        run: |
          mkdir -p ./build-package
          
          # Copy dist files if they exist
          if [[ -d "dist" ]]; then
            cp -r dist/* ./build-package/
          fi
          
          # Copy source for non-wheel deployments
          if [[ -f "setup.py" ]] || [[ -f "pyproject.toml" ]]; then
            cp setup.py ./build-package/ 2>/dev/null || true
            cp pyproject.toml ./build-package/ 2>/dev/null || true
          fi
          
          # Copy requirements for deployment
          cp ${{ inputs.requirements-file }} ./build-package/ 2>/dev/null || true
          
          # Copy application source
          find . -maxdepth 1 -type d ! -name '.*' ! -name 'dist' ! -name 'build' ! -name 'build-package' ! -name '__pycache__' ! -name '.venv' ! -name 'venv' ! -name 'htmlcov' -exec cp -r {} ./build-package/ \; 2>/dev/null || true
          
          cd build-package
          zip -r ../build-artifacts.zip .
          echo "artifact-path=$(pwd)/../build-artifacts.zip" >> $GITHUB_OUTPUT

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ${{ inputs.working-directory }}/build-artifacts.zip
          retention-days: 5
