name: Veracode Security Scan

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Name of the artifact to scan'
        required: true
        type: string
      application-name:
        description: 'Veracode application name'
        required: true
        type: string
      scan-type:
        description: 'Type of scan (policy, sandbox, sca)'
        required: false
        type: string
        default: 'policy'
      sandbox-name:
        description: 'Sandbox name (required for sandbox scans)'
        required: false
        type: string
        default: ''
      fail-on-severity:
        description: 'Minimum severity to fail build (Very High, High, Medium, Low)'
        required: false
        type: string
        default: 'High'
      timeout-minutes:
        description: 'Maximum time to wait for scan completion'
        required: false
        type: number
        default: 60
    outputs:
      scan-status:
        description: 'Scan completion status'
        value: ${{ jobs.veracode-scan.outputs.scan-status }}
      policy-passed:
        description: 'Whether the scan passed policy'
        value: ${{ jobs.veracode-scan.outputs.policy-passed }}
    secrets:
      VERACODE_API_ID:
        required: true
      VERACODE_API_KEY:
        required: true

jobs:
  veracode-scan:
    runs-on: ubuntu-latest
    outputs:
      scan-status: ${{ steps.scan-result.outputs.status }}
      policy-passed: ${{ steps.scan-result.outputs.policy-passed }}
    
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}
          path: ./artifact

      - name: Prepare artifact for scanning
        run: |
          mkdir -p ./scan-target
          cd ./artifact
          if [[ -f "*.zip" ]]; then
            cp *.zip ../scan-target/
          else
            zip -r ../scan-target/application.zip .
          fi
          echo "Artifact prepared for scanning"
          ls -la ../scan-target/

      - name: Veracode Upload and Scan (Policy)
        if: inputs.scan-type == 'policy'
        uses: veracode/veracode-uploadandscan-action@0.2.6
        with:
          appname: ${{ inputs.application-name }}
          createprofile: false
          filepath: ./scan-target/
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          scantimeout: ${{ inputs.timeout-minutes }}
          criticality: 'VeryHigh'

      - name: Veracode Upload and Scan (Sandbox)
        if: inputs.scan-type == 'sandbox'
        uses: veracode/veracode-uploadandscan-action@0.2.6
        with:
          appname: ${{ inputs.application-name }}
          sandboxname: ${{ inputs.sandbox-name || github.ref_name }}
          createsandbox: true
          filepath: ./scan-target/
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}
          scantimeout: ${{ inputs.timeout-minutes }}

      - name: Veracode SCA Scan
        if: inputs.scan-type == 'sca'
        uses: veracode/veracode-sca@v2.1.9
        env:
          SRCCLR_API_TOKEN: ${{ secrets.VERACODE_API_KEY }}
        with:
          path: ./artifact
          create-issues: false
          fail-on-cvss: 7.0

      - name: Get Veracode Policy Results
        id: policy-check
        if: inputs.scan-type == 'policy' || inputs.scan-type == 'sandbox'
        uses: veracode/veracode-pipeline-scan-results-to-sarif@v1.0.5
        continue-on-error: true
        with:
          vid: ${{ secrets.VERACODE_API_ID }}
          vkey: ${{ secrets.VERACODE_API_KEY }}

      - name: Upload SARIF results
        if: always() && (inputs.scan-type == 'policy' || inputs.scan-type == 'sandbox')
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: veracode-results.sarif
        continue-on-error: true

      - name: Evaluate scan results
        id: scan-result
        run: |
          # Default to passed
          POLICY_PASSED="true"
          STATUS="completed"
          
          # Check for high/critical findings based on severity threshold
          SEVERITY_MAP=("Very Low" "Low" "Medium" "High" "Very High")
          THRESHOLD="${{ inputs.fail-on-severity }}"
          
          echo "Scan completed with threshold: $THRESHOLD"
          echo "status=$STATUS" >> $GITHUB_OUTPUT
          echo "policy-passed=$POLICY_PASSED" >> $GITHUB_OUTPUT

      - name: Upload scan report
        uses: actions/upload-artifact@v4
        with:
          name: veracode-scan-report
          path: |
            veracode-results.sarif
            ./scan-target/
          retention-days: 30
